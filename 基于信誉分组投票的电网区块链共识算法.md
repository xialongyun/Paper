### 一、基于智能合约的电网电能交易机制

#### 1.节点的属性	S<sub>i</sub>=<a<sub>i</sub>, b<sub>i</sub>, T<sub>i</sub>, N<sub>i</sub>>

式中，S<sub>i</sub>为电网用于节点i的属性集合；a<sub>i</sub>为电网节点i的地址，b<sub>i</sub>为电网节点i的账户余额；T<sub>i</sub>为电网节点i的信用值，N<sub>i</sub>为电网节点的交易电量总和。节点初次进入系统时，信用值初始化为50，交易电量初始化为0。

#### 2.电能交易流程

- 交易发起前，交易双方规定好用电量等交易细节；
- 将交易细节写入智能合约；
- 交易完成后，智能合约将实际用电量与规定用电量对比，更新信用值；

#### 3.节点信用值更新条件

- 交易结束后，根据双方电量使用情况，更新节点信用值
  - 对于卖方来说，若发电量比智能合约中的规定电量多，则信用值不变；若发电量比智能合约中的规定电量少，则减少信用值；
  - 对于买方来说，若用电量比智能合约中的规定电量多，则信用值不变；若用电量比智能合约中的规定电量少，则减少信用值；

![image-20211018145801173](C:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20211018145801173.png)

### 二、基于信用分组投票的电网区块链共识算法（CGPBFT）

#### 1.分组优化

规则1：“电量均衡”指系统执行分组时，满足各分组之间的交易电量之和基本相同。[[1\]](#_ftn1)

规则2：“信用均衡”指在满足“电量均衡”的条件下，再对各个组的节点进行调节，使得各组内的信用值总和基本相同。

[[1\]](#_ftnref1) 在分组过程中，各个组之间的电量、信用值差距可以根据系统内具体情况进行设置，以达到最优分组结果。

#### 2.信用投票机制

(1)投票结果计算方式——>目的是选举主节点和代理节点

![image-20211022172111635](C:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20211022172111635.png)

(2)节点选举规则

投票结果生成后，系统根据投票规则选出组内代理人节点及系统主节点，同时通过引入备选主节点来增强系统的稳定性。具体投票规则如下：

规则1：对节点的总票数排序，组内票数最高者为组内代理节点。

规则2：代理节点票数最多者为系统主节点。

规则3：节点票数相同时，比较节点历史交易电量，交易电量大者优先成为组内代理节点及系统主节点。

(3)惩罚机制

针对节点可能出现投票消极、随意等行为，引入惩罚机制，即监督节点在共识过程或出块过程的行为，如**出现没有产生区块、产生错误区块、节点宕机**等异常时，对异常节点及组内对该节点投票的节点进行惩罚，降低其信用值。

![image-20211022172653415](C:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20211022172653415.png)
其中，δ<γ，α<β，即惩罚大于奖励。节点信用值积累难，但易丢失，因此，可通过适当增大β、γ参数值，使异常节点及相关节点的信用值较大幅度降低，促使系统内节点诚实投票，通过每个节点的合法参与，使得整个系统更趋向于稳定性。

#### 3.节点替换机制

为了避免节点在共识过程中可能出现（异常行为）主机故障、带宽时延太高，退出电网系统等情况影响系统正常运行，因此，引入节点替换机制，旨在替换发生故障的共识节点，增强系统的安全性。节点替换机制重点加强对共识节点的监管，通常，节点替换发生在以下情况下：
1）	共识节点被发现失职
2）	节点有恶意行为
当主节点出现以上情况时，备选主节点升级为主节点，重新执行优化一致性协议。当代理节点出现以上情况时，本次共识结束后，该节点所在的组重新执行信用投票机制，选出组内新的代理节点。通过该机制，有效降低拜占庭节点参与共识过程的概率，确保了系统安全。

#### 4.信用损耗机制

为了确保节点的活跃程度，引入信用损耗，鼓励节点 积极参与投票、共识。节点信用值损耗算法如下：

![image-20211022173747999](C:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20211022173747999.png)

### 三、CGPBFT机制执行流程

CGPBFT机制执行分组优化机制，将系统节点划分为互不相关的组，各个组内根据信用投票机制，选出每个组内的代理节点，进而构成共识节点集合。此后的共识过程均在该共识集合完成,如果共识集合中的节点达成共识,则将这一段时间内的交易信息写入区块链;若没有达成共识,则剔除该交易数据。

![image-20211022180705942](C:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20211022180705942.png)
